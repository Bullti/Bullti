<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	th:replace="~{layout/common-layout :: commonLayout(~{this::head},~{this::main} )}">
	
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link rel="stylesheet" href="/css/approval/homeTemp.css">
    <link rel="stylesheet" href="/css/department/DeList.css" />
    <title>Mail Reader</title>
</head>
<body>
	<main class="warp-main">
	<div th:replace="~{mail/mail-side :: side}"></div>
	<div style="flex: 1">
	<th:block th:replace="~{layout/header :: header}"></th:block>
    <form id="mailForm">
        <label for="startDate">시작 날짜:</label>
        <input type="date" id="startDate" name="startDate" required>

        <label for="endDate">종료 날짜:</label>
        <input type="date" id="endDate" name="endDate" required>

        <!-- 버튼 클릭 시 getMailData 함수 실행 -->
        <button type="button" onclick="getMailData()">메일 데이터 가져오기</button>
    </form>
	
    <div id="mailResults">
        <table>
            <thead>
                <tr>
                    <th>보낸 사람</th>
                    <th>제목</th>
                    <th>보낸 날짜</th>
                </tr>
            </thead>
            <tbody>
                <!-- Thymeleaf의 th:each를 사용하여 메일 목록을 반복 -->
                 <tr th:each="mail:${mailList}">
				 	<td th:text="${mail.from}"></td>
				 	<td th:text="${mail.subject}"></td>
				 	<td th:text="${mail.sentDate}"></td>
               	 </tr>
            </tbody>
        </table>
    </div>

   <script>

	function formatServerDate(serverDate) {
    var date = new Date(serverDate);
    
    var year = date.getFullYear();
    var month = (date.getMonth() + 1).toString().padStart(2, '0'); // 월은 0부터 시작하므로 1을 더하고 2자리로 패딩
    var day = date.getDate().toString().padStart(2, '0');
    var hours = date.getHours().toString().padStart(2, '0');
    var minutes = date.getMinutes().toString().padStart(2, '0');
    var seconds = date.getSeconds().toString().padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}
	   
  function getMailData() {
    var startDate = document.getElementById("startDate").value;
    var endDate = document.getElementById("endDate").value;

    // 날짜를 JSON 형태로 만들어서 전송
    var requestData = {
        startDate: new Date(startDate).toISOString(),
        endDate: new Date(endDate).toISOString()
    };

    $.ajax({
        type: 'POST',
        url: '/mail/list',
        contentType: 'application/json',
        data: JSON.stringify(requestData),
        success: function (data) {
            console.log(data);

            // Thymeleaf와 연결하여 표시
            var thymeleafTableBody = document.querySelector("#mailResults tbody");
            thymeleafTableBody.innerHTML = "";
            data.forEach(function (mail) {
                var tr = document.createElement("tr");
                var tdFrom = document.createElement("td");
                var tdSubject = document.createElement("td");
                var tdSentDate = document.createElement("td");

                tdFrom.textContent = mail.from;
                tdSubject.textContent = mail.subject;
                tdSentDate.innerHTML = formatServerDate(mail.sentDate);

                tr.appendChild(tdFrom);
                tr.appendChild(tdSubject);
                tr.appendChild(tdSentDate);

                thymeleafTableBody.appendChild(tr);
            });
        },
        error: function (error) {
            console.error('에러:', error);
            var mailResultsDiv = document.getElementById("mailResults");
            mailResultsDiv.innerHTML = "<p>오류가 발생했습니다. 다시 시도해주세요.</p>";
        }
    });
}
   </script>
</main>
</body>
</html>